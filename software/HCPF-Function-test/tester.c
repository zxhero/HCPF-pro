#include"../../rocket-chip/riscv-tools/riscv-pk/pk/pk.h"#include"../mmio.h"#define READ_OFFSET1    0x2000#define READ_DATA1_L       0x2008#define READ_DATA1_H       0x2010#define READ_OFFSET23    0x2018#define READ_DATA23_L       0x2020#define READ_DATA23_H       0x2028#define REQUEST_ADDR    0x2030#define READ_STATUS1    0x2038#define READ_STATUS2    0x2040#define READ_STATUS3    0x2048#define WRITE_SENT      0x2050#define WRITEBACK_SENT    0x2051#define READ_SENT       0x2052#define RESET_PTR		0x2053/*    tester will test    1. reading data from memory                        2. writing new data to memory                        3. writing back data to memory                        4. read finish instruction                        5. clash between 1 & 3 (write read buffer) and 2 & 3 (write write buffer)*/#define Get_Read_Request(size, ptr, raddr, index)   ((((uint64_t)size) << 52) | (((uint64_t)ptr) << 30) | (((uint64_t)raddr) << 2) | (uint64_t)index)#define Get_Write1_Request(size, ptr, waddr)    ((((uint64_t)1) << 62) | (((uint64_t)size) << 52) | (((uint64_t)ptr) << 28) | (uint64_t)waddr)#define Get_WriteRB_Request(offset, data)       ((((uint64_t)3) << 62) | ((uint64_t)4 << 52) | (((uint64_t)offset) << 33) | (((uint64_t)data) << 1))#define Get_WriteWB_Request(ptr, data)  (((uint64_t)3 << 62) | ((uint64_t)4 << 52) | (((uint64_t)ptr) << 33) | (((uint64_t)data) << 1) | 1)#define Get_ReadF_WB_Request(size, num, ptr, offset)     ((((uint64_t)size) << 52) | (((uint64_t)num) << 48) | ((uint64_t)1 << 46) | (((uint64_t)ptr) << 14) | (((uint64_t)offset) << 4) | 12)#define Get_ReadF_Request(num, index)   ((((uint64_t)num) << 48) | (((uint64_t)index) << 46) | 4)#define Read_Format(index, ptr_offset, data_offset1, data_offset2)  ((((uint64_t)index) << 62) | (((uint64_t)ptr_offset) << 56) | (((uint64_t)data_offset1) << 32) | (uint64_t)data_offset2)#define MAX_ID_NUM  64#define MAX_BUF_SIZE    1024    //1024 words, 4096 bytes#define PK_DATA 0x0 void tester(){    uint32_t Rbuf_ptr = 0;    uint32_t Wbuf_ptr = 0;    uint64_t read_status1 = 0;    uint64_t data = 0;    uint64_t *ptr = (uint64_t *)0x80000000;	reg_write8(RESET_PTR,1);	reg_write8(RESET_PTR,0);    // test read dataprintk("start!\n");read_status1 = reg_read64(READ_STATUS1); printk("read status1 : %ld\n", read_status1);    reg_write64(REQUEST_ADDR,Get_Read_Request(16,Rbuf_ptr,0,1));    Rbuf_ptr += 4;    reg_write64(REQUEST_ADDR,Get_Read_Request(16,Rbuf_ptr,16,1));    Rbuf_ptr += 4;	reg_write64(REQUEST_ADDR,Get_Read_Request(16,Rbuf_ptr,16,1));    Rbuf_ptr += 4;	printk("Send all read request!\n");read_status1 = reg_read64(READ_STATUS1);    printk("read status1 : %ld\n", read_status1);//reg_write64(REQUEST_ADDR,Get_ReadF_Request(2,1));	//add//read_status1 = reg_read64(READ_STATUS1);    //printk("read status1 : %ld\n", read_status1);    while(read_status1 != 7){        read_status1 = reg_read64(READ_STATUS1);    }        printk("read request get data back! ");        reg_write64(READ_OFFSET1,Read_Format(1,0,1,0));        data = reg_read64(READ_DATA1_L);        if(data == *ptr){            printk("Get wright data! %ld\n",data);        }        reg_write64(READ_OFFSET1,Read_Format(1,1,1,0));        data = reg_read64(READ_DATA1_L);        if(data == *(ptr + 2)){            printk("Get wright data! %ld\n",data);        }else{			printk("Wrong!\n%d\n%d\n",data,*(ptr+2));		}    //test write new data    reg_write64(REQUEST_ADDR,Get_WriteWB_Request(Wbuf_ptr, 512214));    reg_write64(REQUEST_ADDR,Get_WriteWB_Request(Wbuf_ptr+1, 512214));    Wbuf_ptr += 2;    reg_write64(REQUEST_ADDR,Get_Write1_Request(16,0,PK_DATA));	uint8_t writesent = reg_read8(WRITE_SENT);	printk("Write Sent: %d\n",writesent);    //while((1 & reg_read8(WRITE_SENT)) != 1);    reg_write64(REQUEST_ADDR,Get_Read_Request(16,Rbuf_ptr,PK_DATA,1));    Rbuf_ptr += 4;	read_status1 = reg_read64(READ_STATUS1); 	printk("read status1 : %ld\n", read_status1);    while(read_status1 != 15){		read_status1 = reg_read64(READ_STATUS1); 		printk("read status1 : %ld\n", read_status1);	}    printk("write request get data back! \n");    reg_write64(READ_OFFSET1,Read_Format(1,3,1,0));    data = reg_read64(READ_DATA1_L);    if(data == (((uint64_t)512214 << 32) | 512214)){        printk("Get wright data! %ld\n",data);    }else{			printk("Wrong!\n%ld\n",data);		}    //read finish instruction    reg_write64(REQUEST_ADDR,Get_ReadF_Request(2,1));    //writing back data to memory    reg_write64(REQUEST_ADDR,Get_WriteRB_Request(0,549357));    reg_write64(REQUEST_ADDR,Get_ReadF_WB_Request(8,0,Wbuf_ptr,0));    Wbuf_ptr += 2;	writesent = reg_read8(WRITE_SENT);	//printk("Write Sent: %d\n",writesent);    while(writesent != 1){		writesent = reg_read8(WRITE_SENT);		printk("Write Sent: %d\n",writesent);	}    reg_write64(REQUEST_ADDR,Get_Read_Request(8,Rbuf_ptr,PK_DATA,1));    Rbuf_ptr += 2;    read_status1 = reg_read64(READ_STATUS1); 	printk("read status1 : %ld\n", read_status1);    while(read_status1 != 31){		read_status1 = reg_read64(READ_STATUS1); 		printk("read status1 : %ld\n", read_status1);	}    printk("WB request get data back! ");    reg_write64(READ_OFFSET1,Read_Format(1,0,1,0));    data = reg_read64(READ_DATA1_L);    if(data == (((uint64_t)512214 << 32) | 549357)){        printk("Get wright data! %ld\n",data);    }    //clash between 1 & 3    reg_write64(REQUEST_ADDR,Get_Read_Request(8,Rbuf_ptr,PK_DATA,1));	Rbuf_ptr += 2;    int i = 0;	read_status1 = reg_read64(READ_STATUS1);    while(read_status1 != 63){        reg_write64(REQUEST_ADDR,Get_WriteRB_Request(0,512214));        i ++;        if(i == 10) break;    }    printk("i: %d\n",i);	reg_write64(READ_OFFSET1,Read_Format(1,1,1,0));    data = reg_read64(READ_DATA1_L);    if(data == (((uint64_t)512214 << 32) | 549357)){        printk("Get wright data! %ld\n",data);    }    //clash between 2 & 4   // return 0;}